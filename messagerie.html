<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Messagerie - Planète Cœurs</title>
<link rel="stylesheet" href="style.css">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="app.js"></script>
</head>
<body>
<header><h1>Messagerie privée</h1></header>
<div>
<h3>Choisir un utilisateur pour discuter :</h3>
<div id="users"></div>
</div>
<div id="conversation" style="display:none;">
<h3>Conversation avec <span id="withUser"></span></h3>
<div id="messages" style="height:200px; overflow-y:scroll; border:1px solid #ccc; margin:1em; padding:1em; background:#fff;"></div>
<form id="messageForm">
<input type="text" id="messageInput" placeholder="Votre message" required>
<button type="submit">Envoyer</button>
</form>
</div>
<script>
let currentUser = null, selectedUser = null;

auth.onAuthStateChanged(user => {
if(user){
  currentUser = user.uid;
  db.collection('profils').get().then(snapshot => {
    const usersDiv = document.getElementById('users');
    snapshot.forEach(doc => {
      if(doc.id !== currentUser){
        const btn = document.createElement('button');
        btn.textContent = doc.data().pseudo + ' ('+doc.data().pays+')';
        btn.onclick = () => openChat(doc.id, doc.data().pseudo);
        usersDiv.appendChild(btn);
      }
    });
  });
}else{
  alert("Veuillez vous connecter d'abord.");
  window.location = 'connexion.html';
}
});

function openChat(userId, pseudo){
selectedUser = userId;
document.getElementById('withUser').textContent = pseudo;
document.getElementById('conversation').style.display = 'block';
loadMessages();
}

function loadMessages(){
db.collection('messages')
  .where('participants', 'in', [[currentUser, selectedUser], [selectedUser, currentUser]])
  .orderBy('timestamp')
  .onSnapshot(snapshot => {
    const messagesDiv = document.getElementById('messages');
    messagesDiv.innerHTML = '';
    snapshot.forEach(doc => {
      const msg = doc.data();
      const div = document.createElement('div');
      div.textContent = (msg.from === currentUser ? 'Moi: ' : msg.fromName+': ') + msg.text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  });
}

document.getElementById('messageForm').addEventListener('submit', e => {
e.preventDefault();
const text = document.getElementById('messageInput').value;
db.collection('messages').add({
from: currentUser,
fromName: auth.currentUser.email,
to: selectedUser,
participants: [currentUser, selectedUser],
text,
timestamp: firebase.firestore.FieldValue.serverTimestamp()
});
document.getElementById('messageInput').value = '';
});
</script>
</body>
</html>