<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWMGsMl7Uyqx5mimLiR_lv_u_WCeaU_jY",
  authDomain: "planetes-coeurs-site.firebaseapp.com",
  projectId: "planetes-coeurs-site",
  storageBucket: "planetes-coeurs-site.appspot.com",
  messagingSenderId: "433372689765",
  appId: "1:433372689765:web:8e1e6ae2b776875a329d8c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const textarea = document.querySelector(".new-post textarea");
const publierBtn = document.querySelector(".new-post button");
const container = document.querySelector(".container");

function afficherPost(post) {
  const div = document.createElement("div");
  div.className = "post";
  div.innerHTML = `
    <div class="author">${post.auteur}</div>
    <div>${post.contenu}</div>
    <div style="font-size:12px;color:gray;">${new Date(post.timestamp?.seconds * 1000).toLocaleString()}</div>
    <div class="actions">
      <span>‚ù§Ô∏è ${post.likes || 0} Like</span>
      <span>üí¨ Commentaire</span>
      <span>üîó Partager</span>
    </div>
  `;
  container.appendChild(div);
}

publierBtn.addEventListener("click", async () => {
  const contenu = textarea.value.trim();
  if (!contenu) return alert("√âcris quelque chose !");
  await addDoc(collection(db, "publications"), {
    auteur: "Utilisateur", // plus tard on mettra le vrai nom
    contenu,
    timestamp: serverTimestamp(),
    likes: 0
  });
  textarea.value = "";
});

const q = query(collection(db, "publications"), orderBy("timestamp", "desc"));
onSnapshot(q, snapshot => {
  document.querySelectorAll(".post").forEach(e => e.remove());
  snapshot.forEach(doc => afficherPost(doc.data()));
});

onAuthStateChanged(auth, user => {
  if (!user) {
    alert("Vous devez √™tre connect√© !");
    window.location.href = "index.html";
  } else {
    document.getElementById("username").textContent = user.email;
  }
});
</script>
